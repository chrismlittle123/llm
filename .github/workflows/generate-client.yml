name: Generate TypeScript Client

on:
  push:
    branches: [main]
    paths:
      - "src/progression_labs/llm/server/**"

jobs:
  generate:
    name: Generate Client
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Python dependencies
        run: uv sync --extra server

      - name: Export OpenAPI spec
        run: uv run python scripts/export_openapi.py

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: client/pnpm-lock.yaml

      - name: Install client dependencies
        working-directory: client
        run: pnpm install --frozen-lockfile

      - name: Generate client
        working-directory: client
        run: pnpm run generate

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet openapi.json client/src/generated/ || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create PR
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: regenerate TypeScript client from OpenAPI spec"
          title: "chore: regenerate TypeScript client"
          body: "Auto-generated update to the TypeScript client from changes in the server API."
          branch: chore/regenerate-ts-client
          delete-branch: true
